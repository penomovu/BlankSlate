<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Agora ‚Äì Application de tutorat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  function LIcon({ name, className = "" }) {
    const svg = useMemo(() => {
      try {
        const icon = lucide?.icons?.[name];
        if (!icon) return "";
        return icon.toSvg({ class: className });
      } catch (e) {
        return "";
      }
    }, [name, className]);

    if (!svg) return null;
    return <span dangerouslySetInnerHTML={{ __html: svg }} aria-hidden="true" />;
  }

  const CLASS_LEVELS = ['2nde', '1√®re', 'Terminale'];
  const SUBJECTS = ['Math√©matiques', 'Physique-Chimie', 'Fran√ßais', 'Anglais', 'Histoire-G√©o', 'SVT'];
  const DAYS = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
  const TIME_SLOTS = [
    { id: 'M1', label: '08h-09h' },
    { id: 'M2', label: '09h-10h' },
    { id: 'M3', label: '10h-11h' },
    { id: 'M4', label: '11h-12h' },
    { id: 'S1', label: '13h-14h' },
    { id: 'S2', label: '14h-15h' },
    { id: 'S3', label: '15h-16h' },
    { id: 'S4', label: '16h-17h' },
  ];
  const getLevelValue = (l) => (l === 'Terminale' ? 3 : l === '1√®re' ? 2 : 1);

  class MockBackend {
    constructor() {
      this.users = [
        { id: 'u1', firstName: 'Thomas', lastName: 'Dubois', email: 'thomas@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Thomas', classLevel: '2nde', specialties: [], role: 'STUDENT', isTutorantEnabled: false },
        { id: 'u2', firstName: 'Sophie', lastName: 'Martin', email: 'sophie@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Sophie', classLevel: '2nde', specialties: [], role: 'STUDENT', isTutorantEnabled: false },
        { id: 't1', firstName: 'Lucas', lastName: 'Bernard', email: 'lucas@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Lucas', classLevel: '1√®re', specialties: ['Maths', 'Physique'], role: 'STUDENT', isTutorantEnabled: true },
        { id: 't2', firstName: 'Emma', lastName: 'Petit', email: 'emma@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Emma', classLevel: 'Terminale', specialties: ['SVT', 'Anglais'], role: 'STUDENT', isTutorantEnabled: true },
        { id: 't3', firstName: 'Hugo', lastName: 'Leroy', email: 'hugo@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Hugo', classLevel: 'Terminale', specialties: ['Maths', 'NSI'], role: 'STUDENT', isTutorantEnabled: true },
        { id: 'admin', firstName: 'M.', lastName: 'Directeur', email: 'admin@lycee.fr', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Admin', classLevel: 'Terminale', specialties: [], role: 'ADMIN', isTutorantEnabled: false },
      ];

      this.preferences = [
        { userId: 't1', subjects: ['Math√©matiques', 'Physique-Chimie'], levels: ['2nde'], availableSlots: ['Lundi_S3', 'Mardi_M4', 'Mercredi_S1'], exceptions: [], availableOutsideHours: false },
        { userId: 't2', subjects: ['SVT', 'Anglais'], levels: ['2nde', '1√®re'], availableSlots: ['Lundi_S3', 'Jeudi_S2', 'Vendredi_M3'], exceptions: [], availableOutsideHours: true },
        { userId: 't3', subjects: ['Math√©matiques'], levels: ['2nde', '1√®re', 'Terminale'], availableSlots: ['Lundi_S3', 'Mardi_S4', 'Vendredi_S4'], exceptions: [], availableOutsideHours: false },
      ];

      this.requests = [];
      this.messages = [];
    }

    async login(id) { return this.users.find(u => u.id === id); }

    async setTutorantEnabled(userId, enabled) {
      const u = this.users.find(x => x.id === userId);
      if (u) u.isTutorantEnabled = enabled;
      return u;
    }

    async getTutorsForSlot(slotId, subject, userLevel, userId) {
      return this.users.filter(u => {
        if (u.id === userId) return false;
        if (!u.isTutorantEnabled) return false;

        const prefs = this.preferences.find(p => p.userId === u.id);
        if (!prefs) return false;

        const teachesSubject = prefs.subjects.includes(subject);
        const teachesLevel = prefs.levels.includes(userLevel);
        const isSuperiorOrEqual = getLevelValue(u.classLevel) >= getLevelValue(userLevel);
        const isAvailable = prefs.availableSlots.includes(slotId);

        return teachesSubject && teachesLevel && isSuperiorOrEqual && isAvailable;
      });
    }

    async createRequest(req) {
      const newReq = {
        ...req,
        id: Math.random().toString(36).slice(2, 11),
        createdAt: new Date().toISOString(),
        status: 'PENDING'
      };
      this.requests.push(newReq);

      if (newReq.tutorId) {
        await this.addMessage(newReq.id, newReq.studentId, "Bonjour, je souhaiterais r√©server ce cr√©neau.");
      }
      return newReq;
    }

    async broadcastRequest(studentId, subject, level, slotId) {
      const tutors = await this.getTutorsForSlot(slotId, subject, level, studentId);
      for (const tutor of tutors) {
        await this.createRequest({ tutorId: tutor.id, studentId, subject, level, slotId, isBroadcast: true });
      }
      return tutors.length;
    }

    async getRequestsForUser(userId, mode) {
      return this.requests.filter(r => mode === 'TUTOR' ? r.tutorId === userId : r.studentId === userId);
    }

    async updateRequestStatus(reqId, status) {
      const req = this.requests.find(r => r.id === reqId);
      if (req) req.status = status;
      return req;
    }

    async addMessage(requestId, senderId, content) {
      const msg = { id: Math.random().toString(36).slice(2, 11), requestId, senderId, content, timestamp: new Date().toISOString(), read: false };
      this.messages.push(msg);
      return msg;
    }

    async getMessages(requestId) {
      return this.messages.filter(m => m.requestId === requestId).sort((a, b) => a.timestamp.localeCompare(b.timestamp));
    }

    async savePreferences(prefs) {
      const idx = this.preferences.findIndex(p => p.userId === prefs.userId);
      if (idx >= 0) this.preferences[idx] = prefs;
      else this.preferences.push(prefs);
      return prefs;
    }
  }

  const api = new MockBackend();

  const BADGE_COLORS = {
    blue: "bg-blue-100 text-blue-800",
    green: "bg-green-100 text-green-800",
    red: "bg-red-100 text-red-800",
    gray: "bg-gray-100 text-gray-800",
    purple: "bg-purple-100 text-purple-800",
    yellow: "bg-yellow-100 text-yellow-800"
  };

  function Badge({ children, color = "blue" }) {
    const cls = BADGE_COLORS[color] || BADGE_COLORS.blue;
    return <span className={`px-2 py-0.5 rounded text-xs font-medium ${cls}`}>{children}</span>;
  }

  function Button({ onClick, variant = "primary", className = "", children, disabled = false, type = "button" }) {
    const baseStyle = "px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2";
    const variants = {
      primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm",
      secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
      danger: "bg-red-50 text-red-600 hover:bg-red-100",
      success: "bg-emerald-600 text-white hover:bg-emerald-700"
    };
    return (
      <button type={type} onClick={onClick} disabled={disabled}
        className={`${baseStyle} ${variants[variant] || variants.primary} ${disabled ? "opacity-50 cursor-not-allowed" : ""} ${className}`}>
        {children}
      </button>
    );
  }

  function LoginScreen({ onLogin, users }) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-white flex flex-col justify-center items-center p-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
          <div className="text-center mb-8">
            <div className="inline-flex bg-indigo-600 p-3 rounded-xl mb-4">
              <LIcon name="book-open" className="w-8 h-8 text-white" />
            </div>
            <h1 className="text-2xl font-bold text-gray-900">Bienvenue sur Agora</h1>
            <p className="text-gray-500 mt-2">Connectez-vous avec votre identifiant ENT</p>
          </div>

          <div className="space-y-3">
            <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Comptes de d√©mo</p>
            {users.map((u) => (
              <button key={u.id} onClick={() => onLogin(u.id)}
                className="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all group">
                <img src={u.avatar} className="w-10 h-10 rounded-full mr-3 bg-gray-100" alt="" />
                <div className="text-left">
                  <p className="font-medium text-gray-900 group-hover:text-indigo-700">{u.firstName} {u.lastName}</p>
                  <p className="text-xs text-gray-500">{u.role === "ADMIN" ? "Mod√©rateur" : u.classLevel}</p>
                </div>
                <div className="ml-auto text-gray-400">‚Üí</div>
              </button>
            ))}
          </div>

          <div className="mt-8 pt-6 border-t border-gray-100 text-center text-xs text-gray-400">
            Simulation d'authentification CAS / ENT
          </div>
        </div>
      </div>
    );
  }

  function ChatInterface({ request, currentUser, onBack }) {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState("");
    const [partnerName, setPartnerName] = useState("Utilisateur");

    useEffect(() => {
      let mounted = true;
      api.getMessages(request.id).then((m) => mounted && setMessages(m));

      const partnerId = currentUser.id === request.studentId ? request.tutorId : request.studentId;
      if (partnerId) {
        api.login(partnerId).then((u) => mounted && setPartnerName(u ? `${u.firstName} ${u.lastName}` : "Utilisateur"));
      } else {
        setPartnerName("Groupe");
      }

      const interval = setInterval(() => api.getMessages(request.id).then((m) => mounted && setMessages(m)), 1200);
      return () => { mounted = false; clearInterval(interval); };
    }, [request.id, currentUser.id]);

    const handleSend = async (e) => {
      e.preventDefault();
      if (!newMessage.trim()) return;
      await api.addMessage(request.id, currentUser.id, newMessage);
      setMessages(await api.getMessages(request.id));
      setNewMessage("");
    };

    return (
      <div className="bg-white rounded-xl shadow-lg border border-gray-200 h-[600px] flex flex-col overflow-hidden">
        <div className="bg-indigo-600 p-4 flex items-center gap-3 text-white">
          <button onClick={onBack} className="hover:bg-indigo-700 p-1 rounded" title="Retour">
            <LIcon name="users" className="w-5 h-5" />
          </button>
          <div className="flex-1">
            <h3 className="font-bold">{partnerName}</h3>
            <p className="text-xs text-indigo-200">{request.subject} ‚Ä¢ {request.slotId}</p>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
          {messages.map((msg) => {
            const isMe = msg.senderId === currentUser.id;
            return (
              <div key={msg.id} className={`flex ${isMe ? "justify-end" : "justify-start"}`}>
                <div className={`max-w-[75%] p-3 rounded-xl shadow-sm text-sm ${
                  isMe ? "bg-indigo-600 text-white rounded-br-none" : "bg-white text-gray-800 border border-gray-100 rounded-bl-none"
                }`}>
                  <p>{msg.content}</p>
                  <p className={`text-[10px] mt-1 text-right ${isMe ? "text-indigo-200" : "text-gray-400"}`}>
                    {new Date(msg.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                  </p>
                </div>
              </div>
            );
          })}
          {messages.length === 0 && <p className="text-center text-gray-400 text-sm">Aucun message.</p>}
        </div>

        <form onSubmit={handleSend} className="p-4 bg-white border-t border-gray-100 flex gap-2">
          <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)}
            placeholder="√âcrivez votre message..."
            className="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" />
          <button type="submit" className="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition-colors" title="Envoyer">
            <LIcon name="send" className="w-5 h-5" />
          </button>
        </form>
      </div>
    );
  }

  function TutoreMode({ currentUser }) {
    const [selectedSubject, setSelectedSubject] = useState(SUBJECTS[0]);
    const [selectedSlot, setSelectedSlot] = useState(null);
    const [availableTutors, setAvailableTutors] = useState([]);
    const [loading, setLoading] = useState(false);
    const [broadcastSent, setBroadcastSent] = useState(false);
    const [view, setView] = useState("CALENDAR");
    const [activeChatRequest, setActiveChatRequest] = useState(null);

    useEffect(() => {
      let cancelled = false;
      if (selectedSlot) {
        setLoading(true);
        api.getTutorsForSlot(selectedSlot, selectedSubject, currentUser.classLevel, currentUser.id).then((tutors) => {
          if (cancelled) return;
          setAvailableTutors(tutors);
          setLoading(false);
        });
      } else {
        setAvailableTutors([]);
      }
      return () => { cancelled = true; };
    }, [selectedSlot, selectedSubject, currentUser.id, currentUser.classLevel]);

    const handleRequestHelp = async (tutor) => {
      if (!selectedSlot) return;
      const req = await api.createRequest({
        studentId: currentUser.id,
        tutorId: tutor.id,
        subject: selectedSubject,
        level: currentUser.classLevel,
        slotId: selectedSlot,
      });
      setActiveChatRequest(req);
      setView("CHAT");
    };

    const handleBroadcast = async () => {
      if (!selectedSlot) return;
      setLoading(true);
      await api.broadcastRequest(currentUser.id, selectedSubject, currentUser.classLevel, selectedSlot);
      setLoading(false);
      setBroadcastSent(true);
      setTimeout(() => setBroadcastSent(false), 2500);
      setSelectedSlot(null);
    };

    if (view === "CHAT" && activeChatRequest) {
      return <ChatInterface request={activeChatRequest} currentUser={currentUser} onBack={() => setView("CALENDAR")} />;
    }

    return (
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <LIcon name="search" className="w-5 h-5 text-indigo-500" /> Trouver un tuteur
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Mati√®re</label>
              <select value={selectedSubject} onChange={(e) => setSelectedSubject(e.target.value)}
                className="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border">
                {SUBJECTS.map((s) => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Mon Niveau</label>
              <div className="p-2.5 bg-gray-100 rounded-lg text-gray-600 border border-transparent">{currentUser.classLevel}</div>
            </div>
          </div>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h3 className="text-md font-semibold text-gray-700 mb-4">Disponibilit√©s de la semaine</h3>
          <div className="grid grid-cols-6 gap-2 text-sm">
            <div className="p-2"></div>
            {DAYS.map((d) => <div key={d} className="p-2 font-medium text-center text-gray-500">{d}</div>)}

            {TIME_SLOTS.map((slot) => (
              <React.Fragment key={slot.id}>
                <div className="p-2 text-gray-400 font-medium flex items-center justify-end text-xs">{slot.label}</div>
                {DAYS.map((day) => {
                  const slotId = `${day}_${slot.id}`;
                  return (
                    <button key={slotId} onClick={() => setSelectedSlot(slotId)}
                      className="h-16 rounded-lg border border-dashed border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-colors flex items-center justify-center group relative">
                      <div className="hidden group-hover:flex absolute inset-0 items-center justify-center text-indigo-600 font-medium">Voir</div>
                    </button>
                  );
                })}
              </React.Fragment>
            ))}
          </div>
        </div>

        {selectedSlot && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold text-gray-900">Tuteurs disponibles</h3>
                  <p className="text-sm text-gray-500">{selectedSubject} ‚Ä¢ {selectedSlot.replace("_", " ")}</p>
                </div>
                <button onClick={() => setSelectedSlot(null)} className="p-2 hover:bg-gray-100 rounded-full" title="Fermer">
                  <LIcon name="x-circle" className="w-6 h-6 text-gray-400" />
                </button>
              </div>

              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {loading ? (
                  <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>
                ) : availableTutors.length > 0 ? (
                  availableTutors.map((tutor) => (
                    <div key={tutor.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-white hover:shadow-md transition-all border border-gray-100">
                      <div className="flex items-center gap-4">
                        <img src={tutor.avatar} className="w-12 h-12 rounded-full bg-white" alt="" />
                        <div>
                          <h4 className="font-bold text-gray-900">{tutor.firstName} {tutor.lastName}</h4>
                          <div className="flex gap-2 text-xs mt-1 flex-wrap">
                            <span className="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">{tutor.classLevel}</span>
                            {tutor.specialties.map((s) => <span key={s} className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded">{s}</span>)}
                          </div>
                        </div>
                      </div>
                      <Button onClick={() => handleRequestHelp(tutor)}>Contacter</Button>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-12">
                    <div className="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                      <LIcon name="users" className="w-8 h-8 text-gray-400" />
                    </div>
                    <p className="text-gray-900 font-medium">Aucun tuteur disponible pour ce cr√©neau.</p>
                    <p className="text-gray-500 text-sm mb-6">Lancez un appel pour notifier tous les tuteurs potentiels.</p>
                    <Button onClick={handleBroadcast} variant="primary" className="w-full justify-center">üì¢ Lancer un appel de tutorat</Button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {broadcastSent && (
          <div className="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
            <LIcon name="check-circle" className="w-5 h-5" /> Appel envoy√© aux tuteurs !
          </div>
        )}
      </div>
    );
  }

  function TutorantMode({ currentUser, onToggleTutorantEnabled }) {
    const [activeView, setActiveView] = useState("DASHBOARD");
    const [requests, setRequests] = useState([]);
    const [prefs, setPrefs] = useState(undefined);
    const [activeChat, setActiveChat] = useState(null);

    useEffect(() => {
      let cancelled = false;
      api.getRequestsForUser(currentUser.id, "TUTOR").then((r) => !cancelled && setRequests(r));

      const p = api.preferences.find((p) => p.userId === currentUser.id) || {
        userId: currentUser.id, subjects: [], levels: [], availableSlots: [], exceptions: [], availableOutsideHours: false
      };
      !cancelled && setPrefs({ ...p });
      return () => { cancelled = true; };
    }, [currentUser.id, activeView]);

    const handleStatusChange = async (reqId, status) => {
      await api.updateRequestStatus(reqId, status);
      setRequests((prev) => prev.map((r) => (r.id === reqId ? { ...r, status } : r)));
    };

    const handleToggleSlot = (slotId) => {
      if (!prefs) return;
      const newSlots = prefs.availableSlots.includes(slotId) ? prefs.availableSlots.filter((s) => s !== slotId) : [...prefs.availableSlots, slotId];
      const newPrefs = { ...prefs, availableSlots: newSlots };
      setPrefs(newPrefs);
      api.savePreferences(newPrefs);
    };

    const handleToggleSubject = (sub) => {
      if (!prefs) return;
      const newSubs = prefs.subjects.includes(sub) ? prefs.subjects.filter((s) => s !== sub) : [...prefs.subjects, sub];
      const newPrefs = { ...prefs, subjects: newSubs };
      setPrefs(newPrefs);
      api.savePreferences(newPrefs);
    };

    if (activeChat) return <ChatInterface request={activeChat} currentUser={currentUser} onBack={() => setActiveChat(null)} />;

    return (
      <div className="space-y-6">
        <div className="flex gap-4 border-b border-gray-200 pb-1">
          <button onClick={() => setActiveView("DASHBOARD")}
            className={`pb-3 px-1 font-medium text-sm border-b-2 transition-colors ${activeView === "DASHBOARD" ? "border-indigo-600 text-indigo-600" : "border-transparent text-gray-500 hover:text-gray-700"}`}>
            Tableau de bord
          </button>
          <button onClick={() => setActiveView("PREFERENCES")}
            className={`pb-3 px-1 font-medium text-sm border-b-2 transition-colors ${activeView === "PREFERENCES" ? "border-indigo-600 text-indigo-600" : "border-transparent text-gray-500 hover:text-gray-700"}`}>
            Mes Pr√©f√©rences & Dispo
          </button>
        </div>

        {activeView === "DASHBOARD" ? (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden col-span-1 lg:col-span-2">
              <div className="bg-yellow-50 px-6 py-3 border-b border-yellow-100 flex justify-between items-center">
                <h3 className="font-bold text-yellow-800 flex items-center gap-2"><LIcon name="clock" className="w-4 h-4" /> Demandes en attente</h3>
                <span className="bg-yellow-200 text-yellow-800 text-xs px-2 py-0.5 rounded-full">{requests.filter((r) => r.status === "PENDING").length}</span>
              </div>
              <div className="divide-y divide-gray-100">
                {requests.filter((r) => r.status === "PENDING").length === 0 && <p className="p-6 text-gray-400 italic text-center">Aucune demande en attente.</p>}
                {requests.filter((r) => r.status === "PENDING").map((req) => (
                  <div key={req.id} className="p-4 flex items-center justify-between hover:bg-gray-50">
                    <div>
                      <div className="flex items-center gap-2 mb-1 flex-wrap">
                        <span className="font-bold text-gray-900">{req.subject}</span>
                        {req.isBroadcast && <span className="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded-full flex items-center gap-1"><LIcon name="bell" className="w-3 h-3" /> Appel g√©n√©ral</span>}
                      </div>
                      <p className="text-sm text-gray-600">Cr√©neau: {req.slotId.replace("_", " ")}</p>
                    </div>
                    <div className="flex gap-2">
                      <Button variant="success" className="text-xs px-3 py-1" onClick={() => handleStatusChange(req.id, "ACCEPTED")}>Accepter</Button>
                      <Button variant="danger" className="text-xs px-3 py-1" onClick={() => handleStatusChange(req.id, "REJECTED")}>Refuser</Button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="bg-emerald-50 px-6 py-3 border-b border-emerald-100">
                <h3 className="font-bold text-emerald-800 flex items-center gap-2"><LIcon name="check-circle" className="w-4 h-4" /> S√©ances √† venir</h3>
              </div>
              <div className="divide-y divide-gray-100">
                {requests.filter((r) => r.status === "ACCEPTED").map((req) => (
                  <div key={req.id} className="p-4">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <p className="font-bold text-gray-900">{req.subject}</p>
                        <p className="text-sm text-gray-500">{req.slotId.replace("_", " ")}</p>
                      </div>
                      <button onClick={() => setActiveChat(req)} className="text-indigo-600 hover:bg-indigo-50 p-2 rounded-full" title="Ouvrir le chat">
                        <LIcon name="message-square" className="w-5 h-5" />
                      </button>
                    </div>
                    <Button variant="secondary" className="w-full text-xs mt-2" onClick={() => handleStatusChange(req.id, "HONORED")}>Marquer comme termin√©</Button>
                  </div>
                ))}
                {requests.filter((r) => r.status === "ACCEPTED").length === 0 && <p className="p-6 text-gray-400 italic text-center">Aucune s√©ance pr√©vue.</p>}
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-6 py-3 border-b border-gray-100"><h3 className="font-bold text-gray-700">Historique</h3></div>
              <div className="p-4 max-h-64 overflow-y-auto space-y-3">
                {requests.filter((r) => r.status === "HONORED" || r.status === "REJECTED").map((req) => (
                  <div key={req.id} className="flex justify-between text-sm">
                    <span className="text-gray-600">{req.subject}</span>
                    <Badge color={req.status === "HONORED" ? "green" : "red"}>{req.status}</Badge>
                  </div>
                ))}
                {requests.filter((r) => r.status === "HONORED" || r.status === "REJECTED").length === 0 && <p className="text-gray-400 italic text-center">Aucun historique.</p>}
              </div>
            </div>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="md:col-span-1 space-y-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 className="font-bold text-gray-900 mb-4">Mati√®res enseign√©es</h3>
                <div className="space-y-2">
                  {SUBJECTS.map((sub) => (
                    <label key={sub} className="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" checked={!!prefs?.subjects?.includes(sub)} onChange={() => handleToggleSubject(sub)}
                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span className="text-gray-700">{sub}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 className="font-bold text-gray-900 mb-4">Visibilit√©</h3>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-700">Mode Tutorant actif</span>
                  <button onClick={onToggleTutorantEnabled}
                    className={`w-12 h-6 rounded-full p-1 cursor-pointer transition-colors ${currentUser.isTutorantEnabled ? "bg-indigo-600" : "bg-gray-300"}`}
                    title="Activer/D√©sactiver">
                    <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${currentUser.isTutorantEnabled ? "translate-x-6" : ""}`}></div>
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-2">D√©sactivez pour ne plus appara√Ætre dans les recherches.</p>
              </div>
            </div>

            <div className="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
              <h3 className="font-bold text-gray-900 mb-4">Mon emploi du temps</h3>
              <p className="text-sm text-gray-500 mb-4">Cliquez sur les cr√©neaux o√π vous √™tes libre pour donner des cours.</p>

              <div className="grid grid-cols-6 gap-1 text-xs select-none">
                <div className="p-2"></div>
                {DAYS.map((d) => <div key={d} className="p-2 font-medium text-center text-gray-500">{d.slice(0, 3)}</div>)}

                {TIME_SLOTS.map((slot) => (
                  <React.Fragment key={slot.id}>
                    <div className="p-2 text-gray-400 font-medium flex items-center justify-end">{slot.id}</div>
                    {DAYS.map((day) => {
                      const slotId = `${day}_${slot.id}`;
                      const isSelected = !!prefs?.availableSlots?.includes(slotId);
                      return (
                        <div key={slotId} onClick={() => handleToggleSlot(slotId)}
                          className={`h-12 rounded cursor-pointer transition-all border flex items-center justify-center ${isSelected ? "bg-indigo-600 border-indigo-600 text-white shadow-sm" : "bg-white border-gray-100 hover:border-gray-300"}`}>
                          {isSelected && <LIcon name="check-circle" className="w-4 h-4" />}
                        </div>
                      );
                    })}
                  </React.Fragment>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  function AdminDashboard() {
    const [allMessages, setAllMessages] = useState([]);

    useEffect(() => {
      setAllMessages([...api.messages]);
      const interval = setInterval(() => setAllMessages([...api.messages]), 1000);
      return () => clearInterval(interval);
    }, []);

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <LIcon name="shield" className="w-6 h-6 text-indigo-600" /> Panneau de Mod√©ration
        </h2>
        <div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
          <div className="p-4 border-b border-gray-100 bg-gray-50">
            <h3 className="font-bold text-gray-700">Flux de messages (Tout voir)</h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-50 text-gray-500">
                <tr>
                  <th className="p-3">Horodatage</th>
                  <th className="p-3">Exp√©diteur</th>
                  <th className="p-3">Message</th>
                  <th className="p-3">ID Demande</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {allMessages.map((msg) => (
                  <tr key={msg.id} className="hover:bg-gray-50">
                    <td className="p-3 text-gray-500">{new Date(msg.timestamp).toLocaleString()}</td>
                    <td className="p-3 font-medium">{msg.senderId}</td>
                    <td className="p-3">{msg.content}</td>
                    <td className="p-3 text-gray-400 font-mono text-xs">{msg.requestId}</td>
                  </tr>
                ))}
                {allMessages.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">Aucun message dans le syst√®me.</td></tr>}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }

  function AgoraApp() {
    const [currentUser, setCurrentUser] = useState(null);
    const [appMode, setAppMode] = useState("TUTORE");

    const handleLogin = async (userId) => {
      const user = await api.login(userId);
      if (user) {
        setCurrentUser({ ...user });
        setAppMode(user.role === "ADMIN" ? "ADMIN" : "TUTORE");
      }
    };

    const handleLogout = () => {
      setCurrentUser(null);
      setAppMode("TUTORE");
    };

    const handleToggleTutorantEnabled = async () => {
      if (!currentUser) return;
      const updated = await api.setTutorantEnabled(currentUser.id, !currentUser.isTutorantEnabled);
      setCurrentUser({ ...updated });
    };

    if (!currentUser) return <LoginScreen onLogin={handleLogin} users={api.users} />;

    return (
      <div className="min-h-screen bg-gray-50 font-sans text-gray-900 flex flex-col">
        <header className="bg-white shadow-sm sticky top-0 z-50">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
            <div className="flex items-center gap-3">
              <div className="bg-indigo-600 p-2 rounded-lg"><LIcon name="book-open" className="w-6 h-6 text-white" /></div>
              <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Agora</span>
            </div>

            <div className="flex items-center gap-4">
              {currentUser.role !== "ADMIN" && (
                <div className="flex bg-gray-100 rounded-lg p-1">
                  <button onClick={() => setAppMode("TUTORE")}
                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${appMode === "TUTORE" ? "bg-white text-indigo-600 shadow-sm" : "text-gray-500 hover:text-gray-700"}`}>
                    Je cherche de l'aide
                  </button>
                  <button onClick={() => setAppMode("TUTORANT")}
                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${appMode === "TUTORANT" ? "bg-white text-indigo-600 shadow-sm" : "text-gray-500 hover:text-gray-700"}`}>
                    Je suis tuteur
                  </button>
                </div>
              )}

              <div className="h-8 w-px bg-gray-200"></div>

              <div className="flex items-center gap-3">
                <div className="text-right hidden sm:block">
                  <p className="text-sm font-medium text-gray-900">{currentUser.firstName} {currentUser.lastName}</p>
                  <p className="text-xs text-gray-500">{currentUser.classLevel}</p>
                </div>
                <img src={currentUser.avatar} alt="Profile" className="w-10 h-10 rounded-full border border-gray-200 bg-gray-50" />
                <button onClick={handleLogout} className="text-gray-400 hover:text-red-600 transition-colors" title="D√©connexion">
                  <LIcon name="log-out" className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
        </header>

        <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {appMode === "ADMIN" ? <AdminDashboard /> : appMode === "TUTORE" ? <TutoreMode currentUser={currentUser} /> : <TutorantMode currentUser={currentUser} onToggleTutorantEnabled={handleToggleTutorantEnabled} />}
        </main>

        <footer className="bg-white border-t border-gray-200 mt-auto">
          <div className="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center text-sm text-gray-500">
            <p>¬© 2026 Agora. Entraide scolaire.</p>
            <div className="flex gap-4">
              <button className="hover:text-indigo-600">Contacter l'√©quipe p√©da</button>
              <button className="hover:text-red-600 flex items-center gap-1"><LIcon name="alert-circle" className="w-3 h-3" /> Signaler un abus</button>
            </div>
          </div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<AgoraApp />);
  </script>
</body>
</html>
